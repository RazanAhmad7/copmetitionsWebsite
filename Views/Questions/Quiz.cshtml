@model List<CompetitionsWebsite.ViewModels.QuizQuestionViewModel>

@{
    ViewData["Title"] = "المسابقة - مسابقات تعليمية إسلامية";
    Layout = null;
}
@using System.Text.Json

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  
</head>
<body>
    <header>
        <nav class="main-nav" style="background:#4caf50; padding:10px 30px;">
            <div class="logo" style="color:white; font-weight:bold; font-size:1.5em;">
                مسابقات تعليمية
            </div>
            <div class="nav-links" style="margin-top:5px;">
                <a href="@Url.Action("Index", "Home")" style="color:white; margin-left:15px; text-decoration:none;">الرئيسية</a>
                <a href="@Url.Action("Login", "Auth")" style="color:white; margin-left:15px; text-decoration:none;">تسجيل الدخول</a>
                <a href="@Url.Action("Profile", "Profile")" style="color:white; text-decoration:none;">الملف الشخصي</a>
            </div>
        </nav>
    </header>

    <main>
        <div class="quiz-container">
            <div class="quiz-header">
                <h2 id="quizTitle">المسابقة: @ViewBag.CategoryName - المستوى: @ViewBag.Level</h2>
                <div class="progress-bar">
                    <div class="progress-bar-fill" style="width: 0%"></div>
                </div>
            </div>

            <div id="questionContainer">
                <!-- سيتم عرض السؤال هنا -->
            </div>

            <div class="quiz-controls">
                <button class="btn" id="nextQuestion">التالي</button>
            </div>
        </div>
    </main>

    <footer>
        <p>جميع الحقوق محفوظة © 2024</p>
    </footer>

    <script>
        // بيانات الأسئلة من السيرفر
        window.questionsFromServer = @Html.Raw(Json.Serialize(Model));

        let currentQuestion = 0;
        let score = 0;

        // تعريف درجات الألوان المختلفة
        const colorShades = [
            { bg: "#FFF3E0", border: "#FF9800" }, // برتقالي فاتح
            { bg: "#F3E5F5", border: "#9C27B0" }, // بنفسجي فاتح
            { bg: "#FFEBEE", border: "#F44336" }, // أحمر فاتح
            { bg: "#E0F7FA", border: "#00BCD4" }, // سماوي فاتح
            { bg: "#F1F8E9", border: "#8BC34A" }, // أخضر مصفر
            { bg: "#FFF8E1", border: "#FFC107" }, // أصفر فاتح
            { bg: "#E8EAF6", border: "#3F51B5" }, // نيلي فاتح
            { bg: "#FCE4EC", border: "#E91E63" }, // وردي فاتح
        ];

        const questions = window.questionsFromServer;

        // دالة خلط مصفوفة (Fisher-Yates)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // عرض السؤال الحالي حسب النوع
        function showQuestion() {
            const container = document.getElementById("questionContainer");
            container.innerHTML = "";

            if (currentQuestion >= questions.length) {
                showResults();
                return;
            }

            const question = questions[currentQuestion];

            // بناء هيكل السؤال حسب النوع
            const questionBox = document.createElement("div");
            questionBox.className = "question-type";

            // عنوان السؤال
            const questionText = document.createElement("div");
            questionText.className = "question-text";
            questionText.textContent = question.text;
            questionBox.appendChild(questionText);

            if (question.type.toLowerCase() === "mcq") {
                const optionsContainer = document.createElement("div");
                optionsContainer.className = "options-container";

                question.options.forEach((opt, idx) => {
                    const option = document.createElement("div");
                    option.className = "option";
                    option.textContent = opt;
                    option.dataset.index = idx;
                    option.addEventListener("click", () => selectOption(option));
                    optionsContainer.appendChild(option);
                });

                questionBox.appendChild(optionsContainer);
            }
            else if (question.type.toLowerCase() === "matching") {
                const matchingContainer = document.createElement("div");
                matchingContainer.className = "matching-container";

                // عمود الكلمات
                const rightColumn = document.createElement("div");
                rightColumn.className = "matching-column fixed-column";

                // عمود التعريفات (مختلط)
                const leftColumn = document.createElement("div");
                leftColumn.className = "matching-column movable-column";

                let selectedWord = null;
                let selectedDefinition = null;
                let matchCount = 0;

                // الكلمات (items)
                question.items.forEach(item => {
                    const wordDiv = document.createElement("div");
                    wordDiv.className = "matching-item word-item";
                    wordDiv.textContent = item.text;
                    wordDiv.dataset.word = item.text;

                    wordDiv.addEventListener("click", () => {
                        if (wordDiv.classList.contains("matched")) return;

                        // إزالة التحديد من غيره
                        [...rightColumn.querySelectorAll(".selected")].forEach(el => {
                            if (el !== wordDiv) el.classList.remove("selected");
                        });

                        if (wordDiv.classList.contains("selected")) {
                            wordDiv.classList.remove("selected");
                            selectedWord = null;
                        } else {
                            wordDiv.classList.add("selected");
                            selectedWord = wordDiv;
                        }

                        checkMatch();
                    });

                    rightColumn.appendChild(wordDiv);
                });

                // تعريفات (matches) مخلوطة
                const shuffledMatches = shuffleArray([...question.matches]);

                shuffledMatches.forEach(match => {
                    const defDiv = document.createElement("div");
                    defDiv.className = "matching-item definition-item";
                    defDiv.textContent = match.text;
                    defDiv.dataset.definition = match.text;

                    defDiv.addEventListener("click", () => {
                        if (defDiv.classList.contains("matched")) return;

                        // إزالة التحديد من غيره
                        [...leftColumn.querySelectorAll(".selected")].forEach(el => {
                            if (el !== defDiv) el.classList.remove("selected");
                        });

                        if (defDiv.classList.contains("selected")) {
                            defDiv.classList.remove("selected");
                            selectedDefinition = null;
                        } else {
                            defDiv.classList.add("selected");
                            selectedDefinition = defDiv;
                        }

                        checkMatch();
                    });

                    leftColumn.appendChild(defDiv);
                });

                function checkMatch() {
                    if (!selectedWord || !selectedDefinition) return;

                    const randomColor = colorShades[Math.floor(Math.random() * colorShades.length)];

                    selectedWord.classList.add("matched");
                    selectedDefinition.classList.add("matched");

                    selectedWord.style.backgroundColor = randomColor.bg;
                    selectedWord.style.border = `2px solid ${randomColor.border}`;
                    selectedDefinition.style.backgroundColor = randomColor.bg;
                    selectedDefinition.style.border = `2px solid ${randomColor.border}`;

                    // حفظ الكلمة والتعريف في خصائص data لتقييمهم لاحقًا
                    selectedWord.dataset.matchedWith = selectedDefinition.dataset.definition;

                    selectedWord.classList.remove("selected");
                    selectedDefinition.classList.remove("selected");

                    selectedWord = null;
                    selectedDefinition = null;
                }


                matchingContainer.appendChild(leftColumn);
                matchingContainer.appendChild(rightColumn);
                questionBox.appendChild(matchingContainer);
            }
            else if (question.type.toLowerCase() === "spelling") {
                // عرض الحروف
                const wordBuildingContainer = document.createElement("div");
                wordBuildingContainer.className = "word-building-container";

                const wordPreview = document.createElement("div");
                wordPreview.className = "word-preview";

                // خلط الحروف
                const shuffledLetters = shuffleArray([...question.letters]);

                shuffledLetters.forEach(letter => {
                    const letterBox = document.createElement("div");
                    letterBox.className = "letter-box";
                    letterBox.textContent = letter;

                    letterBox.addEventListener("click", () => {
                        wordPreview.textContent += letterBox.textContent;
                        letterBox.style.visibility = "hidden";
                    });

                    wordBuildingContainer.appendChild(letterBox);
                });

                questionBox.appendChild(wordBuildingContainer);
                questionBox.appendChild(wordPreview);
            }
            else {
                // نوع سؤال غير معروف
                questionBox.innerHTML += "<p>نوع السؤال غير مدعوم</p>";
            }

            container.appendChild(questionBox);

            // تحديث شريط التقدم
            const progress = ((currentQuestion + 1) / questions.length) * 100;
            document.querySelector(".progress-bar-fill").style.width = progress + "%";
        }

        // التعامل مع اختيار خيار في mcq
        function selectOption(option) {
            // إزالة تحديد من كل الخيارات
            document.querySelectorAll(".option").forEach(opt => opt.classList.remove("selected"));
            option.classList.add("selected");
        }

        // الانتقال للسؤال التالي
        function nextQuestion() {
            // تحقق من صحة الإجابة للسؤال الحالي (اختياري حسب نوع السؤال)

            // مثال: عند mcq، نزيد النتيجة إذا كانت الإجابة صحيحة
            const question = questions[currentQuestion];

            if (question.type.toLowerCase() === "mcq") {
                const selectedOption = document.querySelector(".option.selected");
                if (selectedOption) {
                    const selectedIndex = parseInt(selectedOption.dataset.index);
                    if (selectedIndex === question.correctOptionIndex) {
                        score++;
                    }
                }
            }
            else if (question.type.toLowerCase() === "matching") {
                let correctMatches = 0;

                question.items.forEach((item, index) => {
                    const wordEl = [...document.querySelectorAll(".word-item")].find(el => el.dataset.word === item.text);
                    const matchedDef = wordEl?.dataset.matchedWith;
                    const correctDef = question.matches[index]?.text;

                    if (matchedDef === correctDef) {
                        correctMatches++;
                    }
                });

                if (correctMatches === question.items.length) {
                    score++;
                }

            }
            else if (question.type.toLowerCase() === "spelling") {
                const userAnswer = document.querySelector(".word-preview")?.textContent.trim();
                const correctAnswer = question.CorrectWord;
                if (userAnswer && userAnswer === correctAnswer) {
                    score++;
                }
            }

            currentQuestion++;
            if (currentQuestion < questions.length) {
                showQuestion();
            } else {
                showResults();
            }
        }

        // عرض النتيجة النهائية
        function showResults() {
            const container = document.getElementById("questionContainer");
            container.innerHTML = `
                        <h2>انتهت المسابقة!</h2>
                        <p>النتيجة النهائية: ${score} من ${questions.length}</p>
                        <button class="btn" onclick="location.reload()">إعادة المسابقة</button>
                    `;

            document.querySelector(".progress-bar-fill").style.width = "100%";
            document.getElementById("nextQuestion").style.display = "none";
        }

        // تشغيل أول سؤال عند تحميل الصفحة
        document.addEventListener("DOMContentLoaded", () => {
            showQuestion();
            document.getElementById("nextQuestion").addEventListener("click", nextQuestion);
        });
    </script>
</body>
</html>
