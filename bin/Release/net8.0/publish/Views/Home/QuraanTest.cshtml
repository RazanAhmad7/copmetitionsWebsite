@{
    ViewData["Title"] = "توليد اختبار من القرآن الكريم";
}
<link rel="stylesheet" href="~/css/home.css" />
<style>
    .quraan-test-card {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 8px 32px rgba(44, 90, 39, 0.08);
        padding: 2rem 1.5rem 1.5rem 1.5rem;
        max-width: 700px;
        margin: 40px auto 0 auto;
        min-height: 0;
    }

    .quraan-test-title {
        font-size: 2rem;
        font-family: 'Amiri', serif;
        color: #2d5a27;
        margin-bottom: 0.5rem;
        text-align: center;
    }

    .quraan-test-desc {
        text-align: center;
        color: #666;
        font-size: 1.1rem;
        margin-bottom: 1.5rem;
        font-family: 'Cairo', 'Amiri', serif;
    }

    .quraan-form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.2rem 2rem;
        align-items: end;
        margin-bottom: 1.2rem;
    }

    .quraan-form-grid label {
        font-weight: 600;
        color: #2d5a27;
        margin-bottom: 0.3rem;
        font-size: 1rem;
    }

    .quraan-form-grid input[type="range"],
    .quraan-form-grid input[type="number"] {
        width: 100%;
        padding: 0.5rem 0.7rem;
        border-radius: 8px;
        border: 1px solid #e8f5e8;
        font-size: 1rem;
        font-family: 'Cairo', 'Amiri', serif;
    }

    .quraan-form-grid .range-value {
        text-align: center;
        color: #43a047;
        font-size: 0.95rem;
        margin-top: 0.2rem;
        font-weight: 600;
    }

    .quraan-test-btn {
        grid-column: 1 / -1;
        margin-top: 0.5rem;
        width: 100%;
    }

    .quraan-test-results {
        max-width: 700px;
        margin: 24px auto 0 auto;
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
    }

    .quraan-test-box {
        background: #f8f9fa;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(44, 90, 39, 0.04);
        padding: 1.2rem 1rem;
        border: 1px solid #e8f5e8;
        transition: box-shadow 0.2s;
        cursor: pointer;
        position: relative;
    }

    .quraan-test-box:hover {
        box-shadow: 0 8px 24px rgba(244, 162, 97, 0.10);
    }

    .quraan-test-box strong {
        color: #2d5a27;
        font-size: 1.1rem;
    }

    .quraan-test-box .ayah-summary {
        color: #444;
        font-size: 1rem;
        margin: 0.2rem 0;
    }

    .quraan-test-box .show-answer-label {
        color: #f4a261;
        font-size: 0.95rem;
        margin-top: 0.3rem;
        display: block;
    }

    .quraan-test-answer {
        display: none;
        margin-top: 0.7rem;
        padding: 0.7rem 1rem;
        background: #e8f5e9;
        border: 1px dashed #43a047;
        border-radius: 8px;
        color: #2d5a27;
        font-size: 1rem;
        font-family: 'Cairo', 'Amiri', serif;
    }

    @@media
    (max-width: 700px) {

        .quraan-test-card,
        .quraan-test-results {
            max-width: 98vw;
        }

        .quraan-form-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="container" style="min-height:60vh; padding-top: 100px; padding-bottom: 40px;">
    <div class="quraan-test-card">
        <div class="quraan-test-title">توليد اختبار من القرآن الكريم</div>
        <div class="quraan-test-desc">حدد نطاق الأجزاء وعدد الأسطر والأسئلة، وسيتم توليد اختبار مخصص لك من القرآن
            الكريم.</div>
        <div class="quraan-form-grid">
            <div>
                <label for="startJuzRange">بداية الجزء</label>
                <input type="range" id="startJuzRange" min="1" max="30" value="1" />
                <div class="range-value">البداية: <span id="startJuzValue">1</span></div>
            </div>
            <div>
                <label for="endJuzRange">نهاية الجزء</label>
                <input type="range" id="endJuzRange" min="1" max="30" value="30" />
                <div class="range-value">النهاية: <span id="endJuzValue">30</span></div>
            </div>
            <div>
                <label for="lineCount">عدد الأسطر في الاختبار</label>
                <input type="number" id="lineCount" name="lineCount" min="1" max="20" value="5" />
            </div>
            <div>
                <label for="questionCount">عدد الأسئلة المطلوبة</label>
                <input type="number" id="questionCount" name="questionCount" min="1" max="15" value="5" />
            </div>
            <button class="btn btn-primary quraan-test-btn" onclick="generateTest()">توليد الاختبار</button>
        </div>
    </div>
    <div id="results" class="quraan-test-results" style="display: none;">
        <!-- Results will be injected here -->
    </div>
</div>

<script>
    // Elements
    const startJuzRange = document.getElementById('startJuzRange');
    const endJuzRange = document.getElementById('endJuzRange');
    const startJuzValue = document.getElementById('startJuzValue');
    const endJuzValue = document.getElementById('endJuzValue');
    const resultsDiv = document.getElementById('results');

    // Sync sliders
    startJuzRange.addEventListener('input', () => {
        let startVal = parseInt(startJuzRange.value);
        let endVal = parseInt(endJuzRange.value);
        if (startVal > endVal) {
            endJuzRange.value = startVal;
            endJuzValue.textContent = startVal;
        }
        startJuzValue.textContent = startVal;
    });
    endJuzRange.addEventListener('input', () => {
        let startVal = parseInt(startJuzRange.value);
        let endVal = parseInt(endJuzRange.value);
        if (endVal < startVal) {
            startJuzRange.value = endVal;
            startJuzValue.textContent = endVal;
        }
        endJuzValue.textContent = endVal;
    });

    function shortenText(text, wordLimit = 9) {
        const words = text.trim().split(/\s+/);
        return words.length <= wordLimit ? text : words.slice(0, wordLimit).join(" ") + " ...";
    }

    async function generateTest() {
        const startJuz = parseInt(startJuzRange.value);
        const endJuz = parseInt(endJuzRange.value);
        const lineCount = parseInt(document.getElementById('lineCount').value);
        const questionCount = parseInt(document.getElementById('questionCount').value);

        resultsDiv.innerHTML = '';
        resultsDiv.style.display = 'none';

        try {
            const response = await fetch('https://api.alquran.cloud/v1/quran/ar');
            const data = await response.json();

            if (data.code === 200) {
                const allAyahs = [];
                data.data.surahs.forEach(surah => {
                    surah.ayahs.forEach(ayah => {
                        if (ayah.juz >= startJuz && ayah.juz <= endJuz) {
                            allAyahs.push({
                                text: ayah.text,
                                surahName: surah.name,
                                ayahNumber: ayah.numberInSurah,
                                juz: ayah.juz,
                                surahNumber: surah.number
                            });
                        }
                    });
                });
                if (allAyahs.length === 0) {
                    resultsDiv.innerHTML = '<div class="quraan-test-box" style="text-align:center; color:#d7263d;">لا توجد آيات في هذا النطاق!</div>';
                    resultsDiv.style.display = 'flex';
                    return;
                }
                const targetCharCount = lineCount * 80;
                for (let t = 0; t < questionCount; t++) {
                    let startIndex = Math.floor(Math.random() * (allAyahs.length - 1));
                    let currentCharCount = 0;
                    const passage = [];
                    for (let i = startIndex; i < allAyahs.length; i++) {
                        const ayah = allAyahs[i];
                        passage.push(ayah);
                        currentCharCount += ayah.text.length;
                        if (currentCharCount >= targetCharCount) break;
                    }
                    if (passage.length > 0) {
                        const fromAyah = passage[0];
                        const toAyah = passage[passage.length - 1];
                        const box = document.createElement('div');
                        box.classList.add('quraan-test-box');
                        box.innerHTML = `
                      <strong>الاختبار ${t + 1} - ${fromAyah.surahName}</strong><br>
                      <span class="ayah-summary">من: ${shortenText(fromAyah.text)}</span><br>
                      <span class="ayah-summary">إلى: ${shortenText(toAyah.text)}</span><br>
                      <span class="show-answer-label"><i class="fas fa-eye"></i> اضغط لعرض الإجابة</span>
                    `;
                        const answerText = passage.map(p => `● ${p.text}`).join('<br>');
                        const answerDiv = document.createElement('div');
                        answerDiv.className = 'quraan-test-answer';
                        answerDiv.innerHTML = answerText;
                        answerDiv.style.display = 'none';
                        box.appendChild(answerDiv);
                        box.addEventListener('click', () => {
                            answerDiv.style.display = answerDiv.style.display === 'none' ? 'block' : 'none';
                        });
                        resultsDiv.appendChild(box);
                    }
                }
                resultsDiv.style.display = 'flex';
            } else {
                resultsDiv.innerHTML = '<div class="quraan-test-box" style="text-align:center; color:#d7263d;">حدث خطأ أثناء تحميل البيانات.</div>';
                resultsDiv.style.display = 'flex';
            }
        } catch (error) {
            resultsDiv.innerHTML = '<div class="quraan-test-box" style="text-align:center; color:#d7263d;">فشل في الاتصال بواجهة API.</div>';
            resultsDiv.style.display = 'flex';
            console.error(error);
        }
    }
</script>
